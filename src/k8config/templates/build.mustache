{{^node_snapshot_name}}
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: "node-{{node_cache_key}}"
  namespace: "{{namespace}}"
spec:
  storageClassName: "cykubed-storageclass"
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: "{{storage}}Gi"
---
{{/node_snapshot_name}}

apiVersion: batch/v1
kind: Job
metadata:
  labels:
    cykubed-job: "builder"
    project_id: "{{project_id}}"
    local_id: "{{local_id}}"
    testrun_id: "{{testrun_id}}"
    branch: "{{branch}}"
  name: "{{name}}"
  namespace: "{{namespace}}"
spec:
  backoffLimit: 5
  ttlSecondsAfterFinished: 86400
  activeDeadlineSeconds: {{deadline}}
  template:
    spec:
      securityContext:
        runAsNonRoot: true
        fsGroup: 10000
        runAsUser: 10000
        runAsGroup: 10000
      serviceAccountName: "cykubed"
      volumes:
        - name: node-volume
        {{^node_snapshot_name}}
          persistentVolumeClaim:
            claimName: "node-{{node_cache_key}}"
        {{/node_snapshot_name}}
        {{#node_snapshot_name}}
          ephemeral:
            volumeClaimTemplate:
              spec:
                accessModes: [ "ReadWriteOnce" ]
                dataSource:
                  apiGroup: snapshot.storage.k8s.io
                  kind: VolumeSnapshot
                  name: {{node_snapshot_name}}
                resources:
                  requests:
                    storage: "{{storage}}Gi"
        {{/node_snapshot_name}}
        - name: build-volume
          persistentVolumeClaim:
            claimName: "build-{{sha}}"
      restartPolicy: Never
      priorityClassName: "cykubed-low-priority"
      containers:
      - name: "cykubed-builder"
        image: "{{runner_image}}"
        env:
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: "cykubed-redis"
              key: "redis-password"
        - name: BUILD_DIR
          value: "/build"
        - name: NODE_CACHE_DIR
          value: "/node"
        envFrom:
          - configMapRef:
              name: cykubed-agent-configmap
          - secretRef:
              name: cykubed-agent-secrets
        args: [ "build", "{{testrun_id}}"]
        resources:
          limits:
            cpu: "{{cpu_limit}}"
            memory: "{{memory_limit}}G"
          requests:
            cpu: "{{cpu_request}}"
            memory: "{{memory_request}}G"
        volumeMounts:
        - mountPath: "/node"
          name: node-volume
        - mountPath: "/build"
          name: build-volume
